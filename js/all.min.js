// Really crappy js, made even crapper by ad-hoc optimizations :)

(function() {
  var pages = [
    'idea',
    'team',
    'product',
    'execution',
    'growth',
    'focus',
    'ceo',
    'hiring',
    'competition',
    'money',
    'fundraising',
    'closing',
  ];

  // Mobile setup
  var isMobileSetup = false;
  if($(window).width() <= 760) {
    setupMobile();
  }

  $(window).resize(function() {
    if(!isMobileSetup && $(window).width() <= 760) {
      setupMobile();
    }
  });

  function setupMobile() {
    isMobileSetup = true;
    $('.mobile-wrapper').each(function() {
      var $clone = $('h3', this).clone().addClass('is-mobile');
      $(this).after($clone);
      var name = $(this).prev().attr('id');
      $clone.before($('<img>', {
        src: '/img/'+name+'/circle@2x.png',
        class: 'mobile-circle',
      }));
    });
  }

  // Scroll stuff
  var $cached = {};
  var cachedValues = {};

  $.each(pages, function(k, i) {
    $cached[i] = $('.bg-' + i);
    cachedValues[i] = false;
  });
  $w = $(window);

  $closing_sky = $('.bg-closing .sky');
  $closing = $('.bg-closing');

  $w.scroll(function() {
    $.each(pages, function(k, i) {
      var offsetTop = $cached[i].offset().top;
      if(k == 'closing') return;

      var value = $w.scrollTop() + (($w.height() - 420) / 2) > offsetTop;

      if(value != cachedValues[i]) {
        $cached[i][value ? 'addClass' : 'removeClass']('on');
      }

      cachedValues[i] = value;
    });

    var prct = ($w.scrollTop() - $closing_sky.height() + $w.height() - $closing.offset().top) / ($w.height() - $closing_sky.height());
    var s = Math.ceil(prct * 2);

    fire(1, prct, s);
    fire(2, prct, s);
  })

  var $sky = {
    1: $('.sky1'),
    2: $('.sky2'),
  };

  var $sun = $('.sun');

  function fire(i, prct, s) {
    if(s === -0) s = 0;

    var opacity = 0;
    if(i === s) {
      opacity = (prct - ((s-1)*0.5)) * 2;
    } else if(i < s) {
      opacity = 1;
    }

    $sky[i].css('opacity', opacity);
    if(i === 1) {
      $sun.css('transform', 'translate('+ (100 * opacity) +'px,'+(250 * opacity)+'px) rotate('+(20 * opacity)+'deg)');
    }
  }

  $('.top a, .bottom-toc').click(function(e) {
    e.preventDefault();
    $(window).scrollTop($('#toc').offset().top);
  });

  $('.toc a').click(function(e) {
    e.preventDefault();
    $(window).scrollTop($($(this).attr('href')).offset().top);
  });

})();
